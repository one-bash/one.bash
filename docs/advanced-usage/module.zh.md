# 模块 (Module)

one.bash 使用模块来管理脚本。

用户可以使用 `one` 命令来管理模块。按需启用或禁用模块。

模块有三种类型：`alias`, `completion`, `plugin`。

- 所有 plugins 放在每个 repo 的 `plugin/` 目录。
- 所有 completions 放在每个 repo 的 `completion/` 目录。
- 所有 aliases 放在每个 repo 的 `alias/` 目录。
- 所有启用的模块会在 `$ONE_DIR/enabled/` 目录下创建软链接。
  - 使用 `one enabled` 可以查询启用的模块。
  - 使用 `one backup` 备份启动的模块。
- 使用 `one help <mod_type>` 显示使用方法。
- `one <mod_type> enable` 来启用模块。
- `one <mod_type> disable` 来禁用模块。
- `one <mod_type> list` 列出所有模块。

[one.share][] 提供了许多模块、配置、ONE_SUB 命令，以及 bin 命令。

推荐你把 shell 代码移到模块里管理。

## 优先级 (PRIORITY)

one.bash 会按顺序加载模块（根据优先级从低到高）。

此属性为可选属性，每个模块都有默认优先级。

每个模块类型的优先级范围值：

- `plugin`: 300~499, 默认 `400`.
- `completion`: 500~699, 默认 `600`.
- `alias`: 700~799, 默认 `750`.

## 启用模块时传递变量

某些模块可能使用环境变量作为选项。例如 [one.share - zoxide](https://github.com/one-bash/one.share/blob/master/plugin/zoxide.opt.bash)：

```sh
ABOUT='https://github.com/ajeetdsouza/zoxide'
DEPS=zoxide
run_and_append() {
	zoxide init bash --cmd “${ZOXIDE_CMD:-z}” --hook pwd
}
```

用户可以传递 `ZOXIDE_CMD=j` 改变默认值，比如 `ZOXIDE_CMD=j one plugin enable zoxide`

## Write a module

所有模块必须放在 alias/completion/plugin/bin/sub 文件夹中。

### module.bash 的规范

module.bash 文件内容

```sh
about-plugin 'Module Description'
# ONE_LOAD_PRIORITY: 400

# Write your shellscript here
```

- `about-plugin 'Description'`: 模块的描述。这个字段是可选的。
- `one-bash:mod:deps DEPS`: 当 `one <mod> enable` 以及加载 one.bash 时检查系统中是否存在该命令。
  - `DEPS` 是字符串或者数组，如果包含多个命令，必须用数组的形式。比如 `DEPS=(awk sed)`
- `# ONE_LOAD_PRIORITY: <PRIORITY>`: 设置加载优先级。将此行放在脚本的头部。

参考示例：https://github.com/one-bash/one.share

### module.opt.bash 的规范

如果模块需要从远程下载文件，推荐使用 module.opt.bash 格式。

当 `one <mod> enable` 找到 `module.opt.bash` 时，它将创建一个 `mod.bash` 文件，并创建一个指向 `mod.bash` 的符号链接。

最终的模块路径将是：`$ONE_DIR/enabled/priority---name@repo@type.bash` -> `$ONE_DIR/data/type/name/mod.bash`

- `ABOUT=''`: 模块的描述。这个字段是可选的
- `PRIORITY=400`: 模块的优先级。这个字段是可选的
- `GIT_REPO='https://github.com/user/repo.git'`: Git 克隆此仓库。这个字段是可选的
- `SCRIPT='https://raw.githubusercontent.com/...'`: 使用 curl 下载此文件。这个字段是可选的
- `DEPS=(awk sed)`: 当 `one <mod> enable` 时检查系统中的命令。`DEPS` 是一个字符串，其中包含一个或多个以空格分隔的命令名称。

- 在 `one <mod> enable` 中使用的钩子，所有钩子都是可选的。
  - `BEFORE_ENABLE() {}` 这个函数在 `AFTER_DOWNLOAD` 之前执行。用户可以在这实现自定义操作。
  - `AFTER_DOWNLOAD() {}`: 这个函数将在文件下载后执行。用户可以用它来下载其他依赖项、编译等操作。
  - `INSERT() {}`: 函数内容将被插入到模块脚本 (`source $SCRIPT`) 之前。
  - `RUN_AND_INSERT() {}`: 这个函数将被执行，其标准输出将被插入到模块脚本 (`source $SCRIPT`) 之前。
  - `APPEND() {}`: 函数内容将被插入到模块脚本 (`source $SCRIPT`) 之后。
  - `RUN_AND_APPEND() {}`: 这个函数将被执行，其标准输出将被插入到模块脚本 (`source $SCRIPT`) 之后。

- 在 `one <mod> disable` 中使用的钩子，所有钩子都是可选的。
  - `BEFORE_DISABLE() {}` 用户可以在这实现自定义操作。

参考示例：https://github.com/one-bash/one.share

### 最终生成的 mod.bash 的内容

```sh
# This file is generated by one.bash. Do not modify the file content.
# ABOUT: $ABOUT
one-bash:mod:deps $DEPS
$INSERT
$RUN_AND_INSERT()
source $SCRIPT
$APPEND
$RUN_AND_APPEND()
```

### 生成 mod.bash 时的步骤

one.bash 会自动执行下面的步骤。

1. 如果定义了 `DEPS` 或 `one-bash:mod:deps`，检查依赖项
2. 下载文件
3. 如果定义了 `AFTER_DOWNLOAD`，运行该函数
4. 如果定义了 `INSERT`，复制其内容
5. 如果定义了 `RUN_AND_INSERT`，运行该函数，并复制其输出
6. 如果定义了 `APPEND`，复制其内容
7. 如果定义了 `RUN_AND_APPEND`，运行该函数，并复制其输出

### 通过 curl 下载文件

```sh
SCRIPT=https://raw.githubusercontent.com/cheat/cheat/master/scripts/cheat.bash
```

SCRIPT 指向的文件会被下载到 `$ONE_DIR/data/type/name/script.bash`.

### 下载 GIT 项目代码

```sh
GIT_REPO=https://github.com/lincheney/fzf-tab-completion
SCRIPT=bash/fzf-bash-completion.sh
```

```sh
GIT_REPO=https://gitlab.com/repo/user
SCRIPT=path/to/file
```

### 下载 GITHUB release 文件

```sh
GIT_REPO=https://github.com/so-fancy/diff-so-fancy
GITHUB_RELEASE_VERSION=latest
GITHUB_RELEASE_FILES=(diff-so-fancy)
```

- `GITHUB_RELEASE_VERSION`: 这是可选项。默认为 `latest`。

<!-- links -->

[one.share]: https://github.com/one-bash/one.share
