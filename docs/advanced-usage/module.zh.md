# 模块 (Module)

one.bash 使用模块来管理脚本。

用户可以使用 `one` 命令来管理模块。按需启用或禁用模块。

模块有三种类型：`alias`, `completion`, `plugin`。

- 所有 plugins 放在每个 repo 的 `plugin/` 目录。
- 所有 completions 放在每个 repo 的 `completion/` 目录。
- 所有 aliases 放在每个 repo 的 `alias/` 目录。
- 所有启用的模块会在 `$ONE_DIR/enabled/` 目录下创建软链接。
  - 使用 `one enabled` 可以查询启用的模块。
  - 使用 `one backup` 备份启动的模块。
- 使用 `one help <mod_type>` 显示使用方法。
- `one <mod_type> enable` 来启用模块。
- `one <mod_type> disable` 来禁用模块。
- `one <mod_type> list` 列出所有模块。

[one.share][] 提供了许多模块、配置、ONE_SUB 命令，以及 bin 命令。

推荐你把 shell 代码移到模块里管理。

## 优先级 (PRIORITY)

one.bash 会按顺序加载模块（根据优先级从低到高）。

此属性为可选属性，每个模块都有默认优先级。

每个模块类型的优先级范围值：

- `plugin`: 300~499, 默认 `400`.
- `completion`: 500~699, 默认 `600`.
- `alias`: 700~799, 默认 `750`.

## Write a module

All modules must be put in one of alias/completion/plugin folders. And its filename must be suffixed with `.bash` or `.opt.bash`.

### Specifications of module.bash

The file content:

```sh
about-plugin 'Module Description'
# ONE_LOAD_PRIORITY: 400

# Write your shellscript here
```

- `about-plugin`: Description of module. It is optional
- `one-bash:mod:deps awk sed`: To check commands in system when `one <mod> enable`. The DEPS is a string which includes one or more command names separated with spaces.
- `# ONE_LOAD_PRIORITY: <PRIORITY>`: At the head of script for setting priority.

See the examples in https://github.com/one-bash/one.share

### Specifications of module.opt.bash

If a module need download files from remote. It's recommended to use module.opt.bash.

See the examples in https://github.com/one-bash/one.share

- `ABOUT=''`: Description of module. It is optional
- `PRIORITY=400`: Priority of module. It is optional
- `GIT_REPO='https://github.com/user/repo.git'`: Git clone this repo. It is optional
- `URL='https://raw.githubusercontent.com/...'`: curl this file. It is optional
- `DEPS='awk sed'`: To check commands in system when `one <mod> enable`. The DEPS is a string which includes one or more command names separated with spaces.

- hooks used in `one <mod> enable`. They are all optional.
  - `AFTER_DOWNLOAD() {}`: This function will be executed after files downloaded. User may use it to download the other requirements, compile and other things.
  - `INSERT() {}`: The function content will be inserted before module sciprt.
  - `RUN_AND_INSERT() {}`: The function will be executed. And its stdout will be inserted before module sciprt.
  - `APPEND() {}`: The function content will be inserted after module sciprt.
  - `RUN_AND_APPEND() {}`: The function will be executed. And its stdout will be inserted after module sciprt.

### The content of mod.bash

```sh
# This file is generated by one.bash. Do not modify the file content.
# ABOUT: $ABOUT
one-bash:mod:deps $DEPS
$INSERT
$RUN_AND_INSERT()
source $SCRIPT
$APPEND
$RUN_AND_APPEND()
```

The final module will be: `$ONE_DIR/enabled/priority---name@repo@type.bash` -> `$ONE_DIR/data/type/name/mod.bash`

### The order to generate mod.bash

1. check dependencies if `DEPS` or `one-bash:mod:deps` defined
2. download files
3. run `AFTER_DOWNLOAD` if defined
4. copy `INSERT` if defined
5. run `RUN_AND_INSERT` if defined
6. copy `APPEND` if defined
7. run `RUN_AND_APPEND` if defined

### Download file via curl

```sh
SCRIPT=https://raw.githubusercontent.com/cheat/cheat/master/scripts/cheat.bash
```

The script will be downloaded to `$ONE_DIR/data/type/name/script.bash`.
And `SCRIPT=$ONE_DIR/data/type/name/script.bash`.

### Download GITHUB repo

```sh
GITHUB_REPO=https://github.com/lincheney/fzf-tab-completion
SCRIPT=bash/fzf-bash-completion.sh
```

### Download GITHUB release files

```sh
GITHUB_REPO=https://github.com/so-fancy/diff-so-fancy
GITHUB_RELEASE_VERSION=latest
GITHUB_RELEASE_FILES=(diff-so-fancy)
```

- `GITHUB_RELEASE_VERSION`: It's optional. Defaults to `latest`.

<!-- links -->

[one.share]: https://github.com/one-bash/one.share
